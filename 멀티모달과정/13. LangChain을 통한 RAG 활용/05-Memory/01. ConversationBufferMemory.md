# ConversationBufferMemory

이 메모리는 메시지를 저장한 다음 변수에 메시지를 추출할 수 있게 해줍니다.

먼저 문자열로 추출할 수 있습니다.


```python
from langchain.memory import ConversationBufferMemory
```


```python
memory = ConversationBufferMemory()
memory
```

```
C:\Users\SBA\AppData\Local\Temp\ipykernel_23112\2223904900.py:1: LangChainDeprecationWarning: Please see the migration guide at: https://python.langchain.com/docs/versions/migrating_memory/
  memory = ConversationBufferMemory()
ConversationBufferMemory(chat_memory=InMemoryChatMessageHistory(messages=[]))
```


```python
memory.save_context(
    inputs={
        "human": "안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?"
    },
    outputs={
        "ai": "안녕하세요! 계좌 개설을 원하신다니 기쁩니다. 먼저, 본인 인증을 위해 신분증을 준비해 주시겠어요?"
    },
)
```


```python
memory
```

```
ConversationBufferMemory(chat_memory=InMemoryChatMessageHistory(messages=[HumanMessage(content='안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?', additional_kwargs={}, response_metadata={}), AIMessage(content='안녕하세요! 계좌 개설을 원하신다니 기쁩니다. 먼저, 본인 인증을 위해 신분증을 준비해 주시겠어요?', additional_kwargs={}, response_metadata={})]))
```

memory 의 `load_memory_variables({})` 함수는 메시지 히스토리를 반환합니다.


```python
print(memory.load_memory_variables({}))
```

```
{'history': 'Human: 안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?\nAI: 안녕하세요! 계좌 개설을 원하신다니 기쁩니다. 먼저, 본인 인증을 위해 신분증을 준비해 주시겠어요?'}
```


```python
# 'history' 키에 저장된 대화 기록을 확인합니다.
print(memory.load_memory_variables({})["history"])
```

```
Human: 안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?
AI: 안녕하세요! 계좌 개설을 원하신다니 기쁩니다. 먼저, 본인 인증을 위해 신분증을 준비해 주시겠어요?
```

`save_context(inputs, outputs)` 메서드를 사용하여 대화 기록을 저장할 수 있습니다.

- 이 메서드는 `inputs`와 `outputs` 두 개의 인자를 받습니다.
    
- `inputs`는 사용자의 입력을, `outputs`는 AI의 출력을 저장합니다.
    
- 이 메서드를 사용하면 대화 기록이 `history` 키에 저장됩니다.
    
- 이후 `load_memory_variables` 메서드를 사용하여 저장된 대화 기록을 확인할 수 있습니다.
    


```python
# inputs: dictionary(key: "human" or "ai", value: 질문)
# outputs: dictionary(key: "ai" or "human", value: 답변)
memory.save_context(
    inputs={"human": "네, 신분증을 준비했습니다. 이제 무엇을 해야 하나요?"},
    outputs={
        "ai": "감사합니다. 신분증 앞뒤를 명확하게 촬영하여 업로드해 주세요. 이후 본인 인증 절차를 진행하겠습니다."
    },
)
```


```python
# 2개의 대화를 저장합니다.
memory.save_context(
    inputs={"human": "사진을 업로드했습니다. 본인 인증은 어떻게 진행되나요?"},
    outputs={
        "ai": "업로드해 주신 사진을 확인했습니다. 이제 휴대폰을 통한 본인 인증을 진행해 주세요. 문자로 발송된 인증번호를 입력해 주시면 됩니다."
    },
)
memory.save_context(
    inputs={"human": "인증번호를 입력했습니다. 계좌 개설은 이제 어떻게 하나요?"},
    outputs={
        "ai": "본인 인증이 완료되었습니다. 이제 원하시는 계좌 종류를 선택하고 필요한 정보를 입력해 주세요. 예금 종류, 통화 종류 등을 선택할 수 있습니다."
    },
)
```


```python
# history에 저장된 대화 기록을 확인합니다.
print(memory.load_memory_variables({})["history"])
```

```
Human: 안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?
AI: 안녕하세요! 계좌 개설을 원하신다니 기쁩니다. 먼저, 본인 인증을 위해 신분증을 준비해 주시겠어요?
Human: 네, 신분증을 준비했습니다. 이제 무엇을 해야 하나요?
AI: 감사합니다. 신분증 앞뒤를 명확하게 촬영하여 업로드해 주세요. 이후 본인 인증 절차를 진행하겠습니다.
Human: 사진을 업로드했습니다. 본인 인증은 어떻게 진행되나요?
AI: 업로드해 주신 사진을 확인했습니다. 이제 휴대폰을 통한 본인 인증을 진행해 주세요. 문자로 발송된 인증번호를 입력해 주시면 됩니다.
Human: 인증번호를 입력했습니다. 계좌 개설은 이제 어떻게 하나요?
AI: 본인 인증이 완료되었습니다. 이제 원하시는 계좌 종류를 선택하고 필요한 정보를 입력해 주세요. 예금 종류, 통화 종류 등을 선택할 수 있습니다.
```


```python
# 추가로 2개의 대화를 저장합니다.
memory.save_context(
    inputs={"human": "정보를 모두 입력했습니다. 다음 단계는 무엇인가요?"},
    outputs={
        "ai": "입력해 주신 정보를 확인했습니다. 계좌 개설 절차가 거의 끝났습니다. 마지막으로 이용 약관에 동의해 주시고, 계좌 개설을 최종 확인해 주세요."
    },
)
memory.save_context(
    inputs={"human": "모든 절차를 완료했습니다. 계좌가 개설된 건가요?"},
    outputs={
        "ai": "네, 계좌 개설이 완료되었습니다. 고객님의 계좌 번호와 관련 정보는 등록하신 이메일로 발송되었습니다. 추가적인 도움이 필요하시면 언제든지 문의해 주세요. 감사합니다!"
    },
)
```


```python
# history에 저장된 대화 기록을 확인합니다.
print(memory.load_memory_variables({})["history"])
```

```
Human: 안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?
AI: 안녕하세요! 계좌 개설을 원하신다니 기쁩니다. 먼저, 본인 인증을 위해 신분증을 준비해 주시겠어요?
Human: 네, 신분증을 준비했습니다. 이제 무엇을 해야 하나요?
AI: 감사합니다. 신분증 앞뒤를 명확하게 촬영하여 업로드해 주세요. 이후 본인 인증 절차를 진행하겠습니다.
Human: 사진을 업로드했습니다. 본인 인증은 어떻게 진행되나요?
AI: 업로드해 주신 사진을 확인했습니다. 이제 휴대폰을 통한 본인 인증을 진행해 주세요. 문자로 발송된 인증번호를 입력해 주시면 됩니다.
Human: 인증번호를 입력했습니다. 계좌 개설은 이제 어떻게 하나요?
AI: 본인 인증이 완료되었습니다. 이제 원하시는 계좌 종류를 선택하고 필요한 정보를 입력해 주세요. 예금 종류, 통화 종류 등을 선택할 수 있습니다.
Human: 정보를 모두 입력했습니다. 다음 단계는 무엇인가요?
AI: 입력해 주신 정보를 확인했습니다. 계좌 개설 절차가 거의 끝났습니다. 마지막으로 이용 약관에 동의해 주시고, 계좌 개설을 최종 확인해 주세요.
Human: 모든 절차를 완료했습니다. 계좌가 개설된 건가요?
AI: 네, 계좌 개설이 완료되었습니다. 고객님의 계좌 번호와 관련 정보는 등록하신 이메일로 발송되었습니다. 추가적인 도움이 필요하시면 언제든지 문의해 주세요. 감사합니다!
```

`return_messages=True` 로 설정하면 `HumanMessage` 와 `AIMessage` 객체를 반환합니다.


```python
# ConversationBufferMemory를 사용하며 대화 메모리를 새로 생성합니다.
memory = ConversationBufferMemory(return_messages=True)

memory.save_context(
    inputs={
        "human": "안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?"
    },
    outputs={
        "ai": "안녕하세요! 계좌 개설을 원하신다니 기쁩니다. 먼저, 본인 인증을 위해 신분증을 준비해 주시겠어요?"
    },
)

memory.save_context(
    inputs={"human": "네, 신분증을 준비했습니다. 이제 무엇을 해야 하나요?"},
    outputs={
        "ai": "감사합니다. 신분증 앞뒤를 명확하게 촬영하여 업로드해 주세요. 이후 본인 인증 절차를 진행하겠습니다."
    },
)

memory.save_context(
    inputs={"human": "사진을 업로드했습니다. 본인 인증은 어떻게 진행되나요?"},
    outputs={
        "ai": "업로드해 주신 사진을 확인했습니다. 이제 휴대폰을 통한 본인 인증을 진행해 주세요. 문자로 발송된 인증번호를 입력해 주시면 됩니다."
    },
)
```


```python
# history에 저장된 대화 기록을 확인합니다.
memory.load_memory_variables({})["history"]
```

```
[HumanMessage(content='안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?', additional_kwargs={}, response_metadata={}),
 AIMessage(content='안녕하세요! 계좌 개설을 원하신다니 기쁩니다. 먼저, 본인 인증을 위해 신분증을 준비해 주시겠어요?', additional_kwargs={}, response_metadata={}),
 HumanMessage(content='네, 신분증을 준비했습니다. 이제 무엇을 해야 하나요?', additional_kwargs={}, response_metadata={}),
 AIMessage(content='감사합니다. 신분증 앞뒤를 명확하게 촬영하여 업로드해 주세요. 이후 본인 인증 절차를 진행하겠습니다.', additional_kwargs={}, response_metadata={}),
 HumanMessage(content='사진을 업로드했습니다. 본인 인증은 어떻게 진행되나요?', additional_kwargs={}, response_metadata={}),
 AIMessage(content='업로드해 주신 사진을 확인했습니다. 이제 휴대폰을 통한 본인 인증을 진행해 주세요. 문자로 발송된 인증번호를 입력해 주시면 됩니다.', additional_kwargs={}, response_metadata={})]
```


```python
from langchain_core.prompts import ChatPromptTemplate

ChatPromptTemplate.from_messages(
    [
        ("system", "당신은 친절한 AI 봇입니다"),
        ("human", "대한민국의 수도는 어디야?"),
    ]
)
```

```
ChatPromptTemplate(input_variables=[], input_types={}, partial_variables={}, messages=[SystemMessagePromptTemplate(prompt=PromptTemplate(input_variables=[], input_types={}, partial_variables={}, template='당신은 친절한 AI 봇입니다'), additional_kwargs={}), HumanMessagePromptTemplate(prompt=PromptTemplate(input_variables=[], input_types={}, partial_variables={}, template='대한민국의 수도는 어디야?'), additional_kwargs={})])
```

## Chain 에 적용


```python
# API KEY를 환경변수로 관리하기 위한 설정 파일
from dotenv import load_dotenv

# API KEY 정보로드
load_dotenv()
```

```
True
```

확히는 ConversationChain이 ConversationBufferMemory를 LLM 모델에 연결하는 가장 일반적이고 간편한 방법 중 하나


```python
from langchain_openai import ChatOpenAI
from langchain.chains import ConversationChain

# LLM 모델을 생성합니다.
llm = ChatOpenAI(temperature=0, model_name="gpt-4.1-mini")

# ConversationChain을 생성합니다.
conversation = ConversationChain(
    # ConversationBufferMemory를 사용합니다.
    llm=llm,
    memory=ConversationBufferMemory(),
)
```

```
C:\Users\SBA\AppData\Local\Temp\ipykernel_23112\778049493.py:8: LangChainDeprecationWarning: The class `ConversationChain` was deprecated in LangChain 0.2.7 and will be removed in 1.0. Use :class:`~langchain_core.runnables.history.RunnableWithMessageHistory` instead.
  conversation = ConversationChain(
```

`ConversationChain`을 사용하여 대화를 진행합니다.


```python
# 대화를 시작합니다.
response = conversation.predict(
    input="안녕하세요, 비대면으로 은행 계좌를 개설하고 싶습니다. 어떻게 시작해야 하나요?"
)
print(response)
```

```
안녕하세요! 비대면으로 은행 계좌를 개설하는 방법에 대해 안내해 드릴게요. 요즘 대부분의 은행들이 모바일 앱이나 인터넷 뱅킹을 통해 비대면 계좌 개설 서비스를 제공하고 있습니다. 일반적인 절차는 다음과 같습니다:

1. **은행 앱 다운로드 및 설치**
   먼저, 계좌를 개설하고자 하는 은행의 공식 모바일 앱을 스마트폰에 다운로드하세요. 예를 들어, 국민은행(KB국민은행), 신한은행, 우리은행, 하나은행 등 주요 은행들은 모두 앱을 통해 비대면 계좌 개설이 가능합니다.

2. **회원가입 및 본인 인증**
   앱을 실행한 후, ‘비대면 계좌 개설’ 메뉴를 선택합니다. 이후 본인 인증 절차가 진행되는데, 보통 휴대폰 본인 인증, 공인인증서, 또는 신분증(주민등록증, 운전면허증) 촬영을 통해 신원을 확인합니다. 최근에는 영상통화 인증이나 AI 얼굴 인식 기술을 활용하는 은행도 많아졌습니다.

3. **개인 정보 입력 및 약관 동의**
   이름, 주민등록번호, 연락처 등 기본 정보를 입력하고, 은행 이용 약관에 동의합니다.

4. **계좌 종류 선택 및 추가 서비스 신청**
   입출금 계좌, 적금, 예금 등 원하는 계좌 종류를 선택하고, 체크카드 발급, 인터넷 뱅킹, 자동이체 등 추가 서비스를 신청할 수 있습니다.

5. **계좌 개설 완료 및 계좌번호 확인**
   모든 절차가 완료되면 계좌번호가 발급되고, 바로 입출금이 가능합니다. 앱 내에서 잔액 조회, 이체, 카드 신청 등 다양한 금융 서비스를 이용할 수 있습니다.

추가로, 은행마다 조금씩 절차나 요구 서류가 다를 수 있으니, 원하는 은행의 공식 홈페이지나 고객센터를 통해 최신 정보를 확인하는 것이 좋습니다. 혹시 특정 은행을 염두에 두고 계신가요? 그러면 그 은행에 맞는 좀 더 구체적인 안내도 드릴 수 있습니다!
```

이전의 대화 기록을 기억하고 있는지 확인합니다.


```python
# 이전 대화내용을 불렛포인트로 정리해 달라는 요청을 보냅니다.
response = conversation.predict(
    input="이전 답변을 불렛포인트 형식으로 정리하여 알려주세요."
)
print(response)
```

```
물론입니다! 비대면 은행 계좌 개설 절차를 불렛포인트 형식으로 정리해 드릴게요:

- **은행 앱 다운로드 및 설치**
  - 계좌 개설 희망 은행의 공식 모바일 앱을 스마트폰에 설치
  - 예: KB국민은행, 신한은행, 우리은행, 하나은행 등

- **회원가입 및 본인 인증**
  - 앱 실행 후 ‘비대면 계좌 개설’ 메뉴 선택
  - 휴대폰 본인 인증, 신분증 촬영(주민등록증, 운전면허증), 공인인증서 활용
  - 최근에는 영상통화 인증이나 AI 얼굴 인식 기술도 사용

- **개인 정보 입력 및 약관 동의**
  - 이름, 주민등록번호, 연락처 등 기본 정보 입력
  - 은행 이용 약관 동의

- **계좌 종류 선택 및 추가 서비스 신청**
  - 입출금 계좌, 적금, 예금 등 원하는 계좌 유형 선택
  - 체크카드 발급, 인터넷 뱅킹, 자동이체 등 추가 서비스 신청 가능

- **계좌 개설 완료 및 계좌번호 확인**
  - 모든 절차 완료 후 계좌번호 발급
  - 앱 내에서 잔액 조회, 이체, 카드 신청 등 금융 서비스 이용 가능

- **추가 안내**
  - 은행별 절차나 요구 서류가 다를 수 있으니, 해당 은행 공식 홈페이지나 고객센터에서 최신 정보 확인 권장

필요하시면 특정 은행에 맞춘 자세한 안내도 도와드릴 수 있습니다!
```