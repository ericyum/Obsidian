# Adaptive RAG

이 튜토리얼은 Adaptive RAG(Adaptive Retrieval-Augmented Generation)의 구현을 다룹니다. 

Adaptive RAG는 쿼리 분석과 능동적/자기 수정 RAG를 결합하여 다양한 데이터 소스에서 정보를 검색하고 생성하는 전략입니다. 

이 튜토리얼에서는 LangGraph를 사용하여 웹 검색과 자기 수정 RAG 간의 라우팅을 구현합니다.

**주로 다루는 내용**

- **Create Index**: 인덱스 생성 및 문서 로드
- **LLMs**: LLM을 사용한 쿼리 라우팅 및 문서 평가
- **Web Search Tool**: 웹 검색 도구 설정
- **Construct the Graph**: 그래프 상태 및 흐름 정의
- **Compile Graph**: 그래프 컴파일 및 워크플로우 구축
- **Use Graph**: 그래프 실행 및 결과 확인

----

**Adaptive RAG**는 **RAG**의 전략으로, (1) [쿼리 분석](https://blog.langchain.dev/query-construction/)과 (2) [Self-Reflective RAG](https://blog.langchain.dev/agentic-rag-with-langgraph/)을 결합합니다.

[논문: Adaptive-RAG: Learning to Adapt Retrieval-Augmented Large Language Models through Question Complexity](https://arxiv.org/abs/2403.14403) 에서는 쿼리 분석을 통해 다음과 같은 라우팅을 수행합니다.

- `No Retrieval`
- `Single-shot RAG`
- `Iterative RAG`

LangGraph를 사용하여 이를 구현합니다.

이 구현에서는 다음과 같은 라우팅을 수행합니다.

- **웹 검색**: 최신 이벤트와 관련된 질문에 사용
- **자기 수정 RAG**: 인덱스와 관련된 질문에 사용

![adaptive-rag.png](./assets/langgraph-adaptive-rag.png)

---

## 환경 설정

---

## 기본 PDF 기반 Retrieval Chain 생성

여기서는 PDF 문서를 기반으로 Retrieval Chain 을 생성합니다. 가장 단순한 구조의 Retrieval Chain 입니다.

단, LangGraph 에서는 Retirever 와 Chain 을 따로 생성합니다. 그래야 각 노드별로 세부 처리를 할 수 있습니다.

**참고**

- 이전 튜토리얼에서 다룬 내용이므로, 자세한 설명은 생략합니다.

---

## 쿼리 라우팅과 문서 평가

**LLMs** 단계에서는 **쿼리 라우팅**과 **문서 평가**를 수행합니다. 이 과정은 **Adaptive RAG**의 중요한 부분으로, 효율적인 정보 검색과 생성에 기여합니다.

- **쿼리 라우팅**: 사용자의 쿼리를 분석하여 적절한 정보 소스로 라우팅합니다. 이를 통해 쿼리의 목적에 맞는 최적의 검색 경로를 설정할 수 있습니다.
- **문서 평가**: 검색된 문서의 품질과 관련성을 평가하여 최종 결과의 정확성을 높입니다. 이 과정은 **LLMs**의 성능을 극대화하는 데 필수적입니다.

이 단계는 **Adaptive RAG**의 핵심 기능을 지원하며, 정확하고 신뢰할 수 있는 정보 제공을 목표로 합니다.

---

다음은 쿼리 라우팅 결과를 테스트 해본 뒤 결과를 확인합니다.

---

### 검색 평가기(Retrieval Grader)

---

생성한 `retrieval_grader` 를 사용하여 문서 검색결과를 평가합니다.

---

### 답변 생성을 위한 RAG 체인 생성

---

이제 생성한 `rag_chain` 에 질문을 전달하여 답변을 생성합니다.

---

### 답변의 Hallucination 체커 추가

---

생성한 `hallucination_grader` 를 사용하여 생성된 답변의 환각 여부를 평가합니다.

---

### 쿼리 재작성(Query Rewriter)

---

생성한 `question_rewriter` 에 질문을 전달하여 개선된 질문을 생성합니다.

---

### 웹 검색 도구

**웹 검색 도구**는 **Adaptive RAG**의 중요한 구성 요소로, 최신 정보를 검색하는 데 사용됩니다. 이 도구는 사용자가 최신 이벤트와 관련된 질문에 대해 신속하고 정확한 답변을 얻을 수 있도록 지원합니다.

- **설정**: 웹 검색 도구를 설정하여 최신 정보를 검색할 수 있도록 준비합니다.
- **검색 수행**: 사용자의 쿼리를 기반으로 웹에서 관련 정보를 검색합니다.
- **결과 분석**: 검색된 결과를 분석하여 사용자의 질문에 가장 적합한 정보를 제공합니다.

---

웹 검색 도구를 실행하여 결과를 확인합니다.

---

## 그래프 구성

---

### 그래프 상태 정의

---

## 그래프 흐름 정의

**그래프 흐름**을 정의하여 **Adaptive RAG**의 작동 방식을 명확히 합니다. 이 단계에서는 그래프의 상태와 전환을 설정하여 쿼리 처리의 효율성을 높입니다.

- **상태 정의**: 그래프의 각 상태를 명확히 정의하여 쿼리의 진행 상황을 추적합니다.
- **전환 설정**: 상태 간의 전환을 설정하여 쿼리가 적절한 경로를 따라 진행되도록 합니다.
- **흐름 최적화**: 그래프의 흐름을 최적화하여 정보 검색과 생성의 정확성을 향상시킵니다.

---

### 노드 정의

---

## 추가 노드 정의

---

### 그래프 컴파일

**그래프 컴파일** 단계에서는 **Adaptive RAG**의 워크플로우를 구축하고 실행 가능한 상태로 만듭니다. 이 과정은 그래프의 각 노드와 엣지를 연결하여 쿼리 처리의 전체 흐름을 정의합니다.

- **노드 정의**: 각 노드를 정의하여 그래프의 상태와 전환을 명확히 합니다.
- **엣지 설정**: 노드 간의 엣지를 설정하여 쿼리가 적절한 경로를 따라 진행되도록 합니다.
- **워크플로우 구축**: 그래프의 전체 흐름을 구축하여 정보 검색과 생성의 효율성을 극대화합니다.

---

그래프를 시각화 합니다.

---

## 그래프 사용

**그래프 사용** 단계에서는 **Adaptive RAG**의 실행을 통해 쿼리 처리 결과를 확인합니다. 이 과정은 그래프의 각 노드와 엣지를 따라 쿼리를 처리하여 최종 결과를 생성합니다.

- **그래프 실행**: 정의된 그래프를 실행하여 쿼리의 흐름을 따라갑니다.
- **결과 확인**: 그래프 실행 후 생성된 결과를 검토하여 쿼리가 적절히 처리되었는지 확인합니다.
- **결과 분석**: 생성된 결과를 분석하여 쿼리의 목적에 부합하는지 평가합니다.