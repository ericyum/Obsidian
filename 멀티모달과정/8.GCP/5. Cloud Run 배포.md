어제 리마인드

웹기반으로 Vertex AI 서비스 생성형 AI로 코드를 생성 (Gemini-CLI, Claude Code)
Cloud Run으로 컨테이너 생성, 서비스를 배포


배포를 하는 데에 있어서 두 가지 방법이 있다.

### Cloud Run 배포의 두 가지 접근 방식

---

1.  **Cloud Run으로 컨테이너를 생성, 서비스를 배포**
    * 이 방식은 **Cloud Run이 직접 컨테이너 이미지를 빌드하고 배포하는 과정에 관여**하는 경우를 의미합니다. 예를 들어, 소스 코드(예: Python, Node.js 등)를 Cloud Run에 제공하면, Cloud Run이 내부적으로 Cloud Build와 같은 서비스를 활용하여 자동으로 컨테이너 이미지를 생성하고 이를 기반으로 서비스를 배포합니다.
    * **핵심**: 개발자는 소스 코드만 제공하고, **컨테이너 빌드 및 배포는 Cloud Run이 관리**합니다.

2.  **Cloud Run으로 컨테이너를 내가 생성, 서비스를 배포**
    * 이 방식은 **개발자가 미리 Docker 등으로 컨테이너 이미지를 직접 빌드**하여 컨테이너 레지스트리(예: Artifact Registry, Docker Hub 등)에 푸시한 후, 해당 이미지의 경로를 Cloud Run에 제공하여 서비스를 배포하는 경우를 의미합니다. Cloud Run은 개발자가 제공한 컨테이너 이미지를 가져와 배포만 담당합니다.
    * **핵심**: 개발자가 컨테이너 이미지를 직접 빌드하고, **Cloud Run은 배포만 담당**합니다.

---

**결론적으로**, 위 두 가지 방식은 결국 **컨테이너 이미지 생성(빌드) 책임을 누가 지느냐**의 차이로 볼 수 있습니다.

* 첫 번째 방식은 Cloud Run이 컨테이너 빌드까지 도와주는 **자동화된(또는 더 추상화된) 방식**입니다.
* 두 번째 방식은 개발자가 컨테이너 빌드를 직접 수행하고 Cloud Run은 **배포만 담당하는 방식**입니다.



# 오늘 진행 사항

1. Cloud Run에 Chatbot을 생성하고, 구성하고 배포
	Google AI Studio 기반으로 사용할 경우 키 값을 보관하고, 이를 활용(키 관리)
	Vertex AI Studio 기반으로 사용할 경우 IAM에서 설정으로 해서 키를 대신
2. Android Studio를 설치, Cloud run과 연동해서 앱으로 서비스를 배포
	Xcode 환경에서 iOS구성 하는 것은 수업시간 이외에 진행


```
(base) C:\Users\SBA\github\cloudrun2>git clone https://github.com/venture21/cloudrun.git
```

1. Chatbot을 구성하기 위해서
2. [myGemini](https://github.com/venture21/cloudrun/tree/main/myGemini)

우리가 키값을 안정하게 보관하기 위해서는 2가지 개념 기억
1.  .env파일로 키값을 저장하고 사용하는 방법
	(pip install python-dotenv)
2. 사용하는 법 이해
3. github에 업로드할 때 .env파일을 .gitignore파일에 **반드시 등록**


주의) myVertexGemini에서는
1. app.py에서 **프로젝트명(내것)** 변경
2. Local(PC)에서 서버를 실행하고 사용할 때는 키값 인증 대신에 로그인으로 인증을 사용
	**$gcloud auth application-default login**
	실행하면 링크 주소가 뜨고, 인증하는 창이 나타나는데 체크박스 모두 체크하고 인증해주면 권한 부여






# myGemini폴더에서 .env파일 작성하기

myGemini 폴더의 내용을 배포 해보자.

1. 새로운 가상 환경 만들기
```
(base) C:\Users\SBA\github\cloudrun2>conda create -n gemini python=3.11
```

2. 가상환경 실행 후 python-dotenv라이브러리 설치.
```
(base) C:\Users\SBA\github\cloudrun2>conda activate gemini

# python-dotenv라이브러리 설치
(gemini) C:\Users\SBA\github\cloudrun2>pip install python-dotenv
Collecting python-dotenv
  Using cached python_dotenv-1.1.1-py3-none-any.whl.metadata (24 kB)
Using cached python_dotenv-1.1.1-py3-none-any.whl (20 kB)
Installing collected packages: python-dotenv
Successfully installed python-dotenv-1.1.1
```


3. .env라는 이름의 새 파일 만들기(일종의 임시 환경 변수를 지정 하는 곳이라고 보면 된다.)

```
# .env라는 이름의 새 파일 만들기
(gemini) C:\Users\SBA\github\cloudrun2>notepad .env
```

![[Pasted image 20250717095619.png]]
이미지와 같이 작성 후 저장한 뒤

폴더에서 확인해보면 .env라는 숨김 파일이 있는 것을 볼 수 있다.

![[Pasted image 20250717095704.png]]




4. 아래 명령어로 또 다른 파일을 생성하고
```
(gemini) C:\Users\SBA\github\cloudrun2>notepad test_env.py
```

다음의 내용을 넣는다.
```python
from dotenv import load_dotenv  
import os  
  
load_dotenv() # .env 파일 로드  
  
api_key = os.getenv("MY_ENV")   
  
print(f"API Key: {api_key}")  
```
test_env.py를 실행해보면 'Hello'가 출력되는 것을 볼 수 있다.


**아니 그래서 왜 이렇게 .env파일까지 만들어서 일을 하는거지?**

-> **api key는 매우 민감한 정보이기 때문에 이후 .gitignore에 .env파일을 추가해서 올라가지 않도록 해야 한다.**





5. requirements.txt안에 설치해야 하는 것들이 있다. requirements.txt를 읽어서 설치한 후,
```
(gemini) C:\Users\SBA\github\cloudrun2\cloudrun\myGemini>pip install -r requirements.txt
```

6. 아래와 같이 google ai studio에서 발급 받은 api key를 .env.example에 입력
```
(gemini) C:\Users\SBA\github\cloudrun2\cloudrun\myGemini>notepad .env.example
```


![[Pasted image 20250717104847.png]]

그 후 .env.example를 .env로 파일 이름을 변경한다.


7. 이제 콘솔에서
```
python app.py
```
로 실행한다.






# **myVertexGemini**에서 project id과 location 설정하기


이번에는 **myVertexGemini** 폴더로 가서 이를 구동 해볼 것이다.
```
(gemini) C:\Users\SBA\github\cloudrun2\cloudrun\myGemini>cd C:\Users\SBA\github\cloudrun2\cloudrun\myVertexGemini
```




1. myVertexGemini의 app.py에서 내 프로젝트 ID로 수정
```
# Initialize Vertex AI

# TODO: Replace with your actual project ID and location.

PROJECT_ID = "sesac-ericyum9196"

LOCATION = "us-central1"

vertexai.init(project=PROJECT_ID, location=LOCATION)
```

2. 그 후 GCP에 대해 인증을 한다.
```
(gemini) C:\Users\SBA\github\cloudrun2\cloudrun\myVertexGemini>gcloud auth login
```

3. 그 후
```
python app.py
```
로 실행한다.


4. **에러남. 왜 일까?**

```
(gemini) C:\Users\SBA\github\cloudrun2\cloudrun\myVertexGemini>gcloud auth application-default login
```



1.  **`gcloud auth login`**
    * **목적**: 이 명령어는 **사용자 계정(User Account)**으로 `gcloud` CLI(Command Line Interface)를 인증할 때 사용됩니다. 주로 개발자가 자신의 로컬 머신에서 `gcloud` 명령어를 직접 실행하여 Google Cloud 리소스와 상호작용하거나, 프로젝트를 관리할 때 사용합니다.
    * **작동 방식**: 이 명령어를 실행하면 웹 브라우저가 열리고 Google 계정으로 로그인하라는 메시지가 표시됩니다. 로그인이 완료되면, `gcloud` CLI는 해당 사용자 계정의 인증 정보를 얻게 되어, 터미널에서 실행하는 모든 `gcloud` 명령어가 해당 사용자의 권한으로 실행됩니다.
    * **주요 사용처**:
        * Google Cloud Console에 로그인하지 않고 터미널에서 직접 리소스를 생성, 수정, 삭제할 때.
        * `gcloud compute`, `gcloud functions`, `gcloud run` 등 다양한 `gcloud` 명령어를 사용할 때.
        * 로컬 개발 환경에서 빠른 테스트나 관리 작업을 수행할 때.

2.  **`gcloud auth application-default login`**
    * **목적**: 이 명령어는 **애플리케이션(Application)**이 Google Cloud API에 접근할 때 사용할 **애플리케이션 기본 사용자 인증 정보(Application Default Credentials, ADC)**를 설정합니다. 즉, 로컬에서 실행되는 당신의 Python 애플리케이션(예: Flask 앱)이 Google Cloud 서비스(예: Gemini API, Cloud Storage 등)를 호출할 수 있도록 인증 정보를 제공하는 데 사용됩니다.
    * **작동 방식**: 이 명령어를 실행하면 `gcloud auth login`과 유사하게 웹 브라우저가 열리고 Google 계정으로 로그인하라는 메시지가 표시됩니다. 하지만 여기서 얻은 인증 정보는 `gcloud` CLI 자체보다는, Google Cloud 클라이언트 라이브러리(예: `google-cloud-aiplatform`, `google-cloud-storage` 등)가 애플리케이션 내에서 API를 호출할 때 자동으로 찾아 사용하는 기본 위치에 저장됩니다.
    * **주요 사용처**:
        * Python, Node.js, Java 등 다양한 언어로 작성된 애플리케이션이 Google Cloud API를 호출해야 할 때.
        * 로컬 개발 환경에서 애플리케이션을 테스트할 때, 서비스 계정 키 파일을 직접 다운로드하여 환경 변수로 설정하는 번거로움 없이 편리하게 인증할 수 있습니다.
        * `genai.configure(api_key=GOOGLE_API_KEY)`처럼 API 키를 직접 사용하는 경우와는 별개로, Google Cloud 클라이언트 라이브러리가 기본적으로 사용하는 인증 방식입니다.

---

**요약**:

* **`gcloud auth login`**: **당신(사용자)**이 `gcloud` 명령어를 사용할 때의 인증.
* **`gcloud auth application-default login`**: **당신이 개발한 애플리케이션**이 Google Cloud API를 사용할 때의 인증(로컬 개발용).

일반적으로 로컬에서 개발하고 테스트할 때는 두 명령어를 모두 사용하여, `gcloud` CLI와 당신의 애플리케이션 모두 Google Cloud에 접근할 수 있도록 설정하는 것이 편리합니다.





# myGemini와 myVertexGemini 사이의 비교

1. myGemini는 api key를 통해서 google ai studio에 접근해서 사용
2. myVertexGemini는 내가 내 프로젝트의 사용자임을 인증 받고 vertex ai studio의 명령 프롬프트를 사용





# Cloud Run에 올리기


## myGemini 배포

우선 myGemini부터 배포해 볼 것이다. 그런데 **.env에 API KEY값이 있는 데 이것을 올리면 안된다.(API KEY값은 매우 민감한 정보!)** 따라서 배포 명령어세 API KEY를 환경 변수로써 따로 지정해야한다.

기존에 사용하더 명령어에
```
gcloud run deploy flask-chat-app --source . --region=us-central1 --allow-unauthenticated
```

이렇게 키 값을 추가
```
gcloud run deploy flask-chat-app --source . --region=us-central1 --allow-unauthenticated --set-env-vars="GOOGLE_API_KEY=AIzaSyCtfgpQv03W2p4esoyVsk6Guv-wBc3B4Dg"
```


---
### Cloud Run 배포 명령어 설명

1.  **`gcloud run deploy flask-chat-app --source . --region=asia-northeast3 --allow-unauthenticated`**

    이 명령어는 다음과 같은 작업을 수행합니다:

    * **`gcloud run deploy`**: Google Cloud Run에 서비스를 배포하는 명령어입니다.
    * **`flask-chat-app`**: 배포될 서비스의 **이름**입니다.
    * **`--source .`**: **현재 디렉토리(`.`은 현재 디렉토리를 의미)**에 있는 소스 코드를 사용하여 컨테이너 이미지를 빌드하고 배포하라는 의미입니다. Cloud Run은 내부적으로 Cloud Build를 활용하여 이 소스 코드를 기반으로 컨테이너 이미지를 자동으로 생성합니다.
    * **`--region=asia-northeast3`**: 서비스를 배포할 Google Cloud **리전(지역)**을 지정합니다. 여기서는 서울 리전입니다.
    * **`--allow-unauthenticated`**: 이 서비스에 **인증되지 않은 사용자(즉, 로그인하지 않은 일반 인터넷 사용자)**도 접근할 수 있도록 허용한다는 의미입니다. 웹 애플리케이션의 경우 일반적으로 이 옵션을 사용해야 외부에서 접근이 가능합니다.

2.  **`--set-env-vars="GOOGLE_API_KEY=AIzaSyCtfgpQv03W2p4esoyVsk6Guv-wBc3B4Dg"` 추가**

    위 명령어에 `--set-env-vars="GOOGLE_API_KEY=AIzaSyCtfgpQv03W2p4esoyVsk6Guv-wBc3B4Dg"`를 추가한 것은 배포될 `flask-chat-app` 컨테이너 내부에 **`GOOGLE_API_KEY`라는 이름의 환경 변수를 설정하고, 그 값으로 `AIzaSyCtfgpQv03W2p4esoyVsk6Guv-wBc3B4Dg`를 할당하겠다**는 뜻입니다.

    * **`--set-env-vars`**: Cloud Run 서비스에 **환경 변수를 설정하는 플래그**입니다.
    * **`"GOOGLE_API_KEY=AIzaSyCtfgpQv03W2p4esoyVsk6Guv-wBc3B4Dg"`**:
        * **`GOOGLE_API_KEY`**: 환경 변수의 **이름**입니다. 당신의 Flask 애플리케이션 코드에서 `os.environ.get('GOOGLE_API_KEY')`와 같이 이 이름으로 값을 읽어올 것입니다.
        * **`AIzaSyCtfgpQv03W2p4esoyVsk6Guv-wBc3B4Dg`**: 이 환경 변수에 할당될 **값**입니다. 이 값은 당신의 Gemini API 키입니다.

---

**결론적으로**, `--set-env-vars`를 추가하는 것은 당신의 애플리케이션이 실행되는 Cloud Run 컨테이너 환경 내에서 **필요한 비밀 정보(예: API 키)나 설정을 안전하게 주입**하여, 코드에 직접 노출시키지 않고도 접근할 수 있도록 하는 **보안적이고 유연한 방법**입니다.






# myVertexGemini 배포

myVertexGemini 배포는 기존의 코드 그대로 하면 된다.
```
(gemini) C:\Users\SBA\github\cloudrun2\cloudrun\myVertexGemini>gcloud run deploy flask-chat-app --source . --region=us-central1 --allow-unauthenticated
```

이번에는 **--set-env-vars** 가 없어도 잘 되는 것을 볼 수 있다. API KEY를 따로 줄 필요가 없고 GCP의 내가 만들 프로젝트의 사용자임을 인증만 하면 되기 때문이다.




cloud run에 배포시 주의할 점
1. app.py안에 LOCATION을 지정하면 cloud run 명령어 실행 시 LOCATION을 동일하게 설정해야 한다.
2. gcloud run deploy flask-chat-app --source . --region=us-central1 --allow-unauthenticated <- 이 명령어의 region 변수값과 동일하게 한다는 뜻이다.




# 알면 유용한 로그 및 빌드 기록 보는 법

1. GCP를 통해서 배포를 했을 경우에는 GCP의 '로그 탐색기'를 통해서 로그를 볼 수 있다.
2. 또한 Cloud Build의 '기록'에서는 빌드 기록을 볼 수 있다.